package core

import (
	"bitcoin/script"
	"bitcoin/store"
	"bitcoin/util"
	"bytes"
	"context"
	"encoding/hex"
	"fmt"
	"io/ioutil"
	"log"
	"os"
	"testing"
)

func TestAmount(t *testing.T) {
	av := Amount(0)
	h := 125227
	for i := 0; i <= h; i++ {
		av += GetCoinbaseReward(i)
	}
	cv := int64(0)
	store.UseSession(context.Background(), func(db store.DbImp) error {
		cv = db.SumMT(true)
		return nil
	})
	log.Println("all amount = ", av, "db amount", cv)
}

//func TestBlockMoneys(t *testing.T) {
//	err := store.UseSession(context.Background(), func(db store.DbImp) error {
//		if err := G.Init(db); err != nil {
//			return err
//		}
//		for i := uint32(24833); i <= 37077; i++ {
//			h := &BlockHeader{}
//			if err := db.GetBK(store.BKHeight(i), h); err != nil {
//				return err
//			}
//			b := h.ToBlock()
//			if err := b.LoadTXS(db); err != nil {
//				return err
//			}
//			if err := AvailableBlockComing(db, b); err != nil {
//				return err
//			}
//			log.Println("process block height=", i)
//		}
//		return nil
//	})
//	if err != nil {
//		panic(err)
//	}
//}

func TestSaveTXToDat(t *testing.T) {
	data := util.HexDecode("0200000001c5cc15a54bbb6e963d21153fe9320ccef11a1405de54a2bb0a6ef1b08ae015a5010000006a473044022074e0e8a1c4c1dd70f55ebea3ef2472727839168143afb2cfe7d6494ecda4a9ef022048492f3865b6572c97d88aa334e19c6a0947a11c794706fc34a63968d8c76e93012103addffda7b0dc0856fcf248ab830c61e66d24b368393811fe58f955f0aa32e8b6fdffffff02e803000000000000160014751e76e8199196d454941c45d1b3a323f1433bd6004b0000000000001976a9145f2c746007a3171893ea09a21e0d4f4307be2e1a88acc6090900")
	h := NewNetHeader(data)
	tx := &TX{}
	tx.Read(h)
	log.Println(tx.Hash, "save")
	file := fmt.Sprintf("../dat/tx%s.dat", tx.Hash)
	err := ioutil.WriteFile(file, data, os.ModePerm)
	if err != nil {
		t.Errorf("save error %v", err)
	}
}

func TestInfo(t *testing.T) {
	data2 := util.HexDecode("020000000001459a51ed00d715bbe5841de9290ebec29d0af0058c394a3793cb8c438f1126c9af0100000017160014d199e6578c2ae1067bdf114fcc90bb0add86dfadffffffff133e9e388deaf6c4b7d63a30ce4964d2dd3e2142cb582620c9f7ec30275b8a03000000001716001495427c2574be504a0502d7bd11cb89fa5d7451dcffffffffa989ec5547035113b43e42d352702191950da5b6a7e801248d6d4ef92cba82a53600000017160014762212e35300a8cb5a55de1c036336beea468c75ffffffff2bfefa487ae2ba3f2cb02d44e441103d6682f37c7f579df655c713cf0d4bd3a105000000171600143637f90d75181559b9f937377d8783dfaf81803cffffffffd966647f0554513e198eadd44ccf5a27186ce17886584434db14ed48bd3f6f420100000017160014e994e61ac5c0761a949d6776daf63671c767b60bffffffff82fb75574dbc843d2001177cfb34b6e51eb2465ac90195287889f483ec93c8430000000017160014fd4f85a091dbf9f6cac288337fc1831e62b2daa1ffffffff0e57ab5c3dd8bab375fc4777d6a7b93a8a1cebc97c9605e2ca0e73741f0e03420000000017160014a9d63e54ee0dda667cc04db0bfb3fa72b8a1aec8ffffffff38bf4a4de0348835aebbef2be7e9496891cb81701ced1d53fc7b424dcb2ef8ec0000000017160014e498b1410578f15a4d84c2fd4199f8e28cae43d8ffffffffeea7c4f6e670e3b043a5c51f0492d6429f5abe37c80e4e1a1cc0be7cf52ffd8001000000171600148ed84faad3387efdac9329bcbaaa3f4160d665d7ffffffff0b8be412b67e89c07c1d6fb36eee72d5d894796fb7c0825cfbf48511569e3bf302000000171600148ff0c69b4ec5e0d255cab53595483271edde3aa7ffffffff6c2e1093ac8840f0d5834b60dd6d4bf0d5d43c1e4ae01d7bd999f3b198f78e46010000001716001497072a0179c66e0a9b068387f2e16136f70741a2ffffffff078ec23deb03184ab84e1023ae99521e117463f9ea1a990365f3a095d0308bcf0100000017160014266918657a6a0a1aa66eede6d49807b417f87526ffffffffb21a3b52a0bf47b33ccd81572b83ad1ad36967ce2989cdc818e411aa6e8829540100000017160014d3c0eea05e0424f2a3470a72d60fc48b551f5c48ffffffff0c7a2d01542f0c75a67840eacae3eea96014bc092d5435cf8762fd1d5bcba2d800000000171600148629195f7e9ecdbf5771c05f43b7f2d6b57c861effffffff4d2d7f347110ca2d224eec1197bc0bbb8bdeca51f1d07fb1b791dc35977f7c970200000017160014ad3620cd1697146b353e7ae09d9d3816b6507efafffffffff339250befb4e610ac7727b1af2d69fe744487fbc4f9ff74f1fb3e41f0663bfc0100000017160014c5b073425cee6f085ee405c06c9114f497a100a7ffffffff967b7f52d4ede9172731a1bc05babe757e68734eb5175f03a4d7050d7a6a1aca0000000017160014cba585f6f2048df12932b1d74ab9b8ef43fc0925ffffffff7648e3020b153564b4fd6749c24539345597b6c93e718ad8e027a961bd65062a000000001716001496d14ccba9d95a5e939f78132002135082c4b183ffffffff6b3ff91985b4eb8cd27fc23b1899abb79d1429ab07816ade892a9c055970711e01000000171600147cf7de7423d31fe905c8171d20a0c731aa3041abffffffffb7741d93d6d6b9a4deb8d46a4fa31c9a342fd00145e32a44b5a09d007688d74b010000001716001462f68712868cccfe5c355d6c2cd72776add98627ffffffff453b25942a8315d7a99eb86a211433c9f316fd1de3984f361315dbd88c87f2760300000017160014924690d2e4f514d844e040354feb5089c26a8f8effffffff16246151f72b5e6a44ac441971e936db742b734c870485b4e43259882a720c8605000000171600142dfa4ba1b0f5abe52c4a195292d9ecabbd9056cfffffffffc4284d85ac67a0b2841fb9d58f9fd067023f79b36b706fb6fc58e776bf3744370100000017160014f4abc2f00af8bd24bd57c832d8735992a41b6559ffffffff19f1baca27a6c93bdbfb30f6b91fd8b8a20fa40ef4cbea766075f8406058cf8904000000171600141a5a3778f97aff3b7ec3da3a3a881b8633585283ffffffff07942a92c0a6ae4e726ada8b24f08f927699aded98031cec7bbcbe84f5a1144f01000000171600140ebdd3905c9a89e9dbd8d1f5ee3ff4986029696dffffffffc0b88ea33e6182be680a51661ce48ee088570a18982f09cdafc33beb02700fcd0000000017160014b27e3a56bc180ecfb7d8b9290f72c59726b95db3ffffffffe7bfa0aec4919e9b47b6f99dfbc62cbce9cd969a3a6706e11e110238944f06850200000017160014faf195a9bc080670c97859e4643c96a93901cc84ffffffff6590853e45d523cd4960b99667d7bc6bca8feb13d3dabd7e5f48eb85ea724d620400000017160014ebe085767882bf8885c54b078ff8a841b5c29e25ffffffff3dc5d5f7f5c14e777a2587868af4d0922ee26afa8dddc1da11949f555f0323090200000017160014e18082391027d94a04d73ecc5eb154760b6cf7f5ffffffff28052ad78b694a8c04dd9655b25a44b5274cd25953816166343678523cafbcac0100000017160014266918657a6a0a1aa66eede6d49807b417f87526ffffffffb62f25246248b76735a98822188f5ebcc8358f01b287a0c7994bf16741e9c217010000001716001467ad203d23ba075d11dd9b9e9ed8e3ac80f270a3ffffffffe41575d063d1e22e560b525c69d79357f4e37858ed41c29e5711b41141623084000000001716001422319bf13e935f0f3e03a3db350f70dbdb151d3fffffffff2a7be1e5e165c76e7015b881389a749003e34a966f36edec4e8baf6547b513340100000017160014c3ca7eea8432cd75309081416fbe17f7b64ae311ffffffffd18f870f27dd0ca7902059a0ba66d8cb5b989e72bd645c277512bf6eab50f7210100000017160014fad0f875af1e1a35d89ecf8798cafacb9caa229dffffffff4bfb195cb684148eb522bfc1f1fad28674aeb78a292d0eb329db54f2398a00720000000017160014d56d50b760235f7b64824acba71492e6516b692bffffffffc21c2c57515e2f653fc01c0e52e5c054768e890b85f48529f4e205804677ffde000000001716001462bb7259366be4044438eafc4c0850587bbbb0c4ffffffff2bcde4533bdc832c28eb0492e7454284254056aba09b39b160eb527c52b575dd00000000171600148699800c144a6b7b34db217fea8c8bee60a61f98ffffffffe8bf6a2d0bac3de42bae612d31fc286a2f31674ff35e7e06d405e496f7072c3a0a00000017160014c11cbb8ab36ca115abebe769d7c0cab3410b36aeffffffff95b3eaac659d434dfeb5417bdced8f5e140b524ea0c50ad984b1ba7129e6618700000000171600147974afafcae5762c498ca7710e438326f83a1051ffffffffdd67256cb1c776f97ced60ee5c29ddd7b9d308c1672b9b45ca5272b42338381c0800000017160014718b0a19c0d9be5ed968af16837f6f1c6f93b0b3ffffffffdd4f5411b45f0c36173fe33c20fe493e38c6a8c38ff9ee5be2ed166f8421bf7801000000171600145728aec34c65ea9226daf45c819650c5c3167326ffffffff11d41e5f2a9d291fc6c16c539edf661ec9e5d765a0b952cbe719b9caf34ed23700000000171600144a7e1606c8cbdbf5364ffad432c45359815a8b14ffffffffaeeb43022a00187f76d219457d76d95b751bae83d594fcae4e45e00c139e1b7102000000171600149d70c4ae208d7fcc1f7bd2ff837acb9dff00addeffffffff0e25ee47c612721ca8e774ad8a2e992b331cb0f14d7931240e842717de7fd6b40300000017160014f46c0bd1e169143ed4f7b7424e2ce432cafda03bffffffff84d1fc6b31e9cfbffbd60b86a828a670ecaab9377aaad8658eaf335a0d77e24e0100000017160014df4872a606f6d89cc88749daa8b6dafbd01a02f4ffffffff6b1677af1b6f23d68f93c8fa48b949145d1776c47e57175eaef8c5453e202eaf0000000017160014fa330009031a6df2d218c1543de5b2020fa413edffffffffcdbb4bbee57071795d627f2bcaa9c29297e47c034ac2b1db0396b188c9f6ab0a000000001716001490477e92a0290dfd1fc126f212866d2578348bb2ffffffff8453044a0eefb1b882872addea8ed44f741c501364ce72717e19c7149dbe8abe0100000017160014f34456edc0fc50ca151a761606a8d4d5ce8373cffffffffff406bd16b777bb9d4928b51eead814f95bb2102b5434d522bef33915c8a884300400000017160014337e0bb0679f74d9fcaf8cc779b98096837e1f9effffffff1e52ba64f8fccf2222af09e0969a2d40e6ea2753bf9c9ebad12af9b0e03026660200000017160014c9bf4e36f3d37874a557bf57f360994a29ec2ca0ffffffffc0b25e228d78ff63982a2b3c8684c03cb4ca2c7b5364b741aab50619a78f16eb00000000171600144729e0fa42d37942b5b41ee4e5ad38f31aa4089ffffffffff19d76c1d94d421955eb90945e298ed457a76b657c1f97f11f8df99f86de60a601000000171600145f5b51ab166fca8e6eadc96219976f75c568b546ffffffff2007fc2c6c16f4418205d0b24f666c2a3080d44f86019c1df54f4b3f8c43bafe000000001716001424ea25e68cea36158b38eb3765cad53856c760d8ffffffffbd2321ba0b855344c1d56db39b25ee427cb2c2a5604888b8bb5a97374f8bbbcb00000000171600149d80c07118e95f4aa8a92a720b124cc289e4dd16ffffffff7a5addfe6e799b081fe6226b80c95f9de57673516ac851b84b3a6cafb95f5e530000000017160014174c4c0727e115496d133dfe38ac8ac48d4fdb1cffffffff142b32777135c11f53245a119d2583a53141a30fcf05933c1219305bebec7e9601000000171600148875cbd09e33bf136ab0753709483c49323bebcdffffffff1330cc234f00c5489bb309faeacd29580d88018bad632cc5d55e97ca833a21c20100000017160014449a05bc8d531ebff457690650da75e3405dcd05ffffffff7a70ab70d96869803c847748b7229597d1e4afc525dd8f37664dc91bdf2df70d01000000171600142d1ccdc1c2e9a8f1761b8e6870c31197fe975d49ffffffffb3282a0c4805b0d266e78b8c72c3e2179a67cabc1cd965eceaf4f8500bc2a96900000000171600142c715ff819c577d5f9d28069b115fc0c6da29984ffffffffc272e1ffd68bc21584bb61757eee3fc655b126251a6efde00839c2908e56e12e010000001716001482ee043de9aad6927712047ec65897262d4e3755ffffffff61098880140204aff6fde373d42fb01f5908a48ee1614b053c35bf9a089ddcb101000000171600145165cc52e3624758172109be3b118e7ccc8e02b6ffffffff188e69bb8930555d4c54a973171464a990738d525d4c8ba31b939629a13850a201000000171600145bd498f768a428a55bf823e312f28d6ea63987fcffffffff81cfc90f0be863c2ef4b60c3832ad4c8db0aa4deb5b914e19d012fdb4439c6a800000000171600147113b81751779fe25b1772f50f116cf33fb94ff4ffffffff80ca9c94bb98a5a78b35d15a40c14b26f3ddf917e9cce7a89170a5ed5e45122901000000171600146bdfd2194d609f151960b286ca039c5857d7b23cffffffff82443f0f8e01c52c96faf5119d0029757ef0685d11cadc51b379fa576df9f87e070000001716001491c31bd6ae204e1d1e985b113163fc32ad24bdfaffffffff1a26b4018a79c94c54ed3d30dfb71d99711131810e7f1e62c26f3ffe5e417bf80000000017160014537d943b783f4d32d8de1676fc204e18e3ddfe54ffffffff9194338931fbf7b99afa5d8e164868513f9adb5535b3f048f1a8d2f44356363700000000171600148514dd712703e221af77c2ec08d09d076e92eb9fffffffff7ef910d9753781bba64b8571f36539a37a6945a6b45a6ba055f780c0881887530100000017160014ed337b51ad165a110efbb1b981d9c934631382eeffffffffc04c2cfba8716d99f65455cb5abb3af6b082c02a9d1c1f7830174a913401399e0100000017160014758e8106929d9e031efc92597b7b5a09fae81607ffffffff020084d717000000001976a91410f6bb3791bc8fefda5ca150aca2a9ce0ca62af788acf4aa0c000000000017a914a4f19588c53fca58db7276c789e277106abfef838702473044022074ac263b1b740cd2cc6ccf626d250a294f326c901feb2d54dc43570800a53a4f02200f2e0993ade89fc0cb1f53f83c864d51b5fdbedb99ed67efd9179fd02210cfe3012102c740ec70954b8e7c199977dfe24c5983e923945ce143596d72356ddc96c09d7b0247304402203d647a0531b35600161b6b1cdb8d5528dd3c5a2f3d5ca5de7a8b938bbc7296e802204562962adf1504c3af2c523702271b8f2a1cb80d368b6d3f44c5d1acd44d0dd40121025fa1f05d59db41bb270ccf73c491e9f428857f983755576a487bd3566012cd47024730440220252e254e0a2b05c496c862df0d03d55198c7c94c6d239bb6968ef7e12767f6e8022000cbd8c15f915042e75b3ae6c16ce3f58e34e8dd20ae249f0c0905cb1df909eb01210394e4d8c5be88a1ac078025d1e712ddb7ee3439fa9ff346430427606ea97d2fe1024730440220118a1fdc00d97d7a79359fa0079b7fca7d23cbd7b2da6713b021a65dda39399302207180a372d965af0023931ae3832d31f77974e10f93a3253c6c97c9fc16db2bbd0121035b6ac7c20133e2505e779b97d7733f0ae694c706f21edd6cbe1af6c3cabacb6d02473044022005c3e477b2e888dc1ba8092df6b764d77494dccc1277fbc9aa8b049c64f7592e022070fcf74b22692abb65044416a94c5b0b2590a6d19d996320709944e521fc3a7b012103a66f20cdc10d5972f103809e66946e0f4300aaa674fd646ebaeb7b3ca425cf830247304402201c308914bcfde061bad5b5ec668263dff9f3829cc5556a999eb805d5b840b1d402206cbdc028145b1fed214653a73a10a614615a27cb30d785b37916bb7178ea9ab6012102aff5060642bf065c282b94394c6409c2c4feaff5d70b183e4f347c5b6b76507a0247304402204d5f432cb025a1a1b262344d5fb20d82321f8b96e70675ff40c2d680928f692d022031eeea53b4a942b14fc465610ff9ac9ae91fab54e1a1297f9998554e97ae324a012103614c17ca4e5a92131cdb4e5be1f87f7c4831cf9128449d43cbe50f4de429adc302463043021f4e52f8a9333aa12976bf218b79b6ff1089c1fbbb5c13788fce5c842c789cc60220419204db6243fc9c7f953a1a64caed12507c0055f0e0265915b945e97ab28a5e01210231a65a7925fe3b36f5ff08596e3280cdce004591bea89065626f7b821da2d9c30247304402207c70f58734c5eee24082ee701bc621faf9b5d7ffbbd7b7e3896467f7c0fb9318022016612183365183cbbc48a67323bd6a69a4f7e2d1cf6bfb82e50c69fc86b05978012103b41028b4ab31ef4035afb7c4c8bc881d149142ffea0ed634b04541b7fd2f6a900247304402200ca80382b7eaadd3e08827771066853f78e20f0030f72f0c378d9ecd6fd1cd8002205e6f70a7a0032b735e7cd62eef8fd9397e557be55d2d5758f0a0575f3fa56fdf01210317522c31e06edc6d35146c24bf04cbe37b7f17371920f359728b26ab9802fc460247304402201ddaf10c414b74019ae008641495e05f29e4f1fce1e79738c3a64c548c77d2ee0220408f9a7f738355ffa1dc313d0346812491a7d81386f1cdd812879a9eae9a843601210383732050826cc50857a0596066571262d4763d1a5323dc7969d91d44c1fb416e02473044022049296b8fd83142775d23e34bcc598cf2bd77df8974d3b98c34d3cc821cf6bbd802205b70245492c28f9e52adf6604cff43b37fde5742737a9e25d2b30428128788ea01210343620ed89a9e6426eaf6d95d8712b2e8d4f6c5100e9e820a674ee4fc25bd05c80247304402207633827bddb7d300f320d5433cb939949e32105fcb75e2dbd3cd6290c7a345670220457274575e9c6fff1adf85efd155b17984c50f74b4b1657dd5eac1e98c6f42bc0121020e797b318643bcbd8d01486079613bdb01b205f7a497d513e6491a4891a9f5130247304402204041c0b11aedfa773cbeffae65950b821362989141150b45bfadc12713f4671a0220479cc3391283ea25d7bed57203e55a062e420cf2968562d40eb1ea548f06c84b012103fed7ac21596098b1e1c923913603e48af79a7445b9960436b90545d6782ba9d802473044022049c252729ed8df3fa4f3ccdbc87c0978acfad515151f560829f5f8740d29c1da02204c11a7c05a671301f7c212d54d2a1d7b974884e6c3af76ab65a79bac255bb329012103072796d47b86a4bc1803e052d5877e7896f7af8985e9b70fcf3408874947bcbe0247304402207fb81b6a952d10480701eacc58101268c28c252d0284c6febf6ca47184b1bde40220664f30b354d390ab08d4467c13ab0e7905cfe4473ad2c6543b9bd22a21df4604012102bf277b76795bbed8c4a6ce4cedc3c3033f20a85f3617415bb1ff0311355a0f550247304402205a34b87f0f6fcae46de0d427b9be7dc66f2b1a9f8ef8dccdc638fc5d344a1c7c02203cf01fb2578816f9baedb19b48a8a32f5a45c8c09d20309815f8fca7ca2caa0a01210338a5a1f616b0d684e6e0fb7c3369812c6e8327b9778f4060fb8a74ca47e157e90247304402205ae6809bf31d91ff27258aa5cff6c2ea2c286e469e9b5a4f538f02df0dc39ea60220586b103bd7c6960adf4328f2811fc5e2f67ff676a205f049a3fce998d2da88c4012103c440784928b836452c188f5e1f89a43176f51b18dff02e74334f0833fede6e13024730440220710febe9ee187f2d6f232a4a26ad4bd6ca7cbd902065210279d82b8228cf324902204ade1c022c61294b7ccd9a0c06cf1f1cc68bcdd5d00316cd53c46a773f0e6950012102c3b82b3b2289fe230c6f6f0a89e4ff9bfd921015867cbd70313f9e38eedb17840247304402201bbc943a74e74934650736bc599257b3b42887b53d8c6d1097660eec296a0e490220012016548d1208648e3bdd0348cc296092070b28007503be53f5010a143e69130121035dac3b3676479a2be969511a2c24e7124204ced572c0a9e7244d0b84db4af4090247304402202f4d7ea1bfe157aac778be7615aee5b6a3e83e69ba751fa330565f52626aa8a102207bb1af3ac9402a1753b85da383771101e6be690594c72d568e9caa0e1205e150012103d4fbbf9162ffd940d5910faedbbc19658e31c2896736a75a41a5ff5adaf3a2f6024730440220538a8de32dad13f177d646a7916c9f95aefc9a60798bf6edcc9a81be54c9852602206eee4c9abbbdcad610b5568b57be523b9038b8861b5ef33665b7b6cea2116d130121026890a5951d5653eeb42ed452ce32d4d20f282b5ce53a7fd15a75c1d4ea4b3537024730440220626d3d753661e55b7d47fe7d078cea1b7667fb61c26e14328dabaeffb50ada5a022067e635c384332347d85db7ca9fd48a3be75968c18434fbea31ac9043a1c11d86012103b637b8a0f800fc8467d8c6446eee3945491cb684a1c6f0ac2f9e34685392833702473044022037919b2353b4d56b86d4add01fe5700cbba6e1e4727ba4737e7f3ec2f616289c022073df3148cbf9de1127e819659717698a0a42b6dd403514891d08ffa1147387b40121032ef28c57a64b2f8f6b1fb5141d0c74a5e0be6228bf6af170c46b691e074a1e8e02473044022004e86614f295145a72632bb46d5806635a80a64d8cba947c376bf1e478148ba402202eb7beecf9ad94e8f252d058c9fe640b079794fa10442aca9d8be6fe8e9b146301210311428f0d031215ee0cd489869967c5f10d69b31f0e809671a3b53bcba22ccdaa02473044022042a2e0b6cd79b1645f6d4ea7272b2aea90b0f224a15ea35ddba39538bd4af91b0220067efdf636336fbb0f9d3479d971c09751ab41e70100133141523e74054cf099012102e71ac0869a4a3b7a52638ba6db7ce53516579c02280b02e497d69deb0de05eea0247304402203d87fc2ce8cb7f119ca1eacbbc4bde45ed7c87eec77ff0d2d2e8d86441ee5a4c02206cdd9ab11a8d9842712ae54a53cdd6e5c585c25f332efd805c5d101808d84e0a01210228f6d7cc3d21e6a3dfc6c656903e3aaf752d39feb3a6a5a6c5d0020ebbe22eff02473044022059155ba051f2600e009a3b06ff811c00e3d1adcafbf08f113ec51131904806a302204beedab3b547ddf017a874465d4011cbf952d27bb167451d8db0cd4f378ca23a012103f23b51477aae4322ffdbe4ad5888f2374dcb1a4c66a0b70159e828dfb5066da502473044022002eaba4ee76d36ea7d4bcec21a806abfd09ecaf817a1acc093812d6ff985363d02203c93e9fe360d27b136399a8aa73571966e023fe1570cd060ee1ac1cb27eb437e0121039e6b87b271aff36560afe104710d4b75a2896723d41456920f5e8f0447048e5c0247304402205fcf3adf8320b01ccfe6c5439188ac60b9b8e67e314b3f52391a8666d454442202201982129d2f08af2ac25ad0b626d4d849796fc0588e8daba75ccea37777663ce101210343620ed89a9e6426eaf6d95d8712b2e8d4f6c5100e9e820a674ee4fc25bd05c802473044022071f145b3fb57bfae58d679559bc0531437749f4503bc5ff80d313698bae9409a02206a3aa343f75b49e1d4f5f72e3ef121f37ed6076e00f17c3903314738f6d9083b01210264bda86bf8fb8008dc58aa7d3be1a6f6e8e5f1b11bea89340dfccc9187dc2432024730440220693b5e02b940f92811999070aa4276fff1de446b5b94f0486193b497f34dab1602201a95be4168b8e12a89a579b07420e70c19b8f349957f7a35b7c8a865f2493c5b012102b5ba226735404b2219692dcaa3df4188462a8f2e7c3d53104f90b03e62e6f2de024730440220195330485feb5ff915190b9f84bab7f80b3298a7e77194f14875f7326ad18c5a022043b4494ac263730a7336f72dcd0bac7fef09ba56488a2e0f8e15dae36ce3e193012103c41bf0ed78ac03e459667cbedc3ca1e6f5461a204e9d7abd17ea25e36770f54f02473044022051e77bf93ee7223c39b6e33daf60f31ed80358bca555f05d0af324459e5ba56f02204550213a3d0837838051ea6e551744d0f761f0f7ce69f0003246652090ac70f201210233d03fe467d0564aa08685c6fd6c735843890696e38fd74f2bd18cede7f75ce102473044022069b0984ec464fdcffbbb5c5316fe10cee5cfb3bf4aeaef943d6376639641890c02200759fc068cc6777b03f09b9238862e9b3efb2564032ac4c47557fdf57df205110121038ee7a0a9badb456404136340443970092b3ea6a5d14855eee05772d77c0ead8b024730440220315f7b012bc464b866f109196ec4f719ae9964400fad0e411ad5b6aea7979b4802206453b97a1804fd51b16333ec7c40ace6242d5c6cf8572e52dbad86c1256d6594012103ca2e5af803efaf9a2aae5e553ce35fc18309fbbb5ce3d22dd4ab06b66692a64a02473044022022b70a5c7aafe1ff94a4fb32ad62cb41db4a27a7a2f6ec2de6d38c6ad80e35d1022072423967cb1a939dbd70eedab78586f66a73ac89b63a143a1b8f96fed97f9846012103903587128ac11e494401982c9def098ad66859e14136a93f1dde0bc86d16737902473044022070ee1cf9d0252fb675360e11a117ed31283d72ec2c9cec63407bcd6affa8928d02206faab27c3dbe4f2ca07feac4ffdad695e102d4665b6791bb6cf0a9fcba1eccaf01210316705d8ddd6e89514f8f7ea294db5f818cd63ce682284e99fa36034bc795bc090247304402203cf68d27eab69136a9c1ad53bad77be72c4891ef5f81fa2fa300cf99633a8143022054dfb609c9e7e94f8054f5c9da66bcac82df75e361d546e4c95f472fa57de14801210367f6c0234985bd62ee29ccd25de037a86738e2fb00c6fb6f38d66ff7af347ea40247304402206ffc8d69e67cc8417c26ee12a4d3fece15fd06822151272e8872375823d68ec5022057920063b420244efb6342780e02d53e4b719e248f0f880e3c94c44ccbc2a9c301210301733559d762b91e20679a19a62b66d491b1faf67e26c687b3df817535ad73170247304402201b55a5d56d7ab4cbdc75a2b0232bfb41f388df3ecc3c2cfc9a7cef50a07af5f2022031df9b61cf47d7773f642308d52778915af859798648842f7ac4f19aa1004fd0012103823cdb2b6112cd89287e8d1a859c7b1cee117a522621b559a6d163a30d4e48460247304402207d5fbad1e5062a5e970cce404e0aa2fa269c2b306f66c46f2a28f56cc1988b88022045506197d720ad7430243990576f6392dcad33c08f5ec1ee1d35e7890a0344b40121023a141e8897c85b04348c297134b7e8f86dcb3328d6be957abd91b612b1f936870247304402201eb1740abbf95b323d9358d437e55b7f407fe4e8e89b8d4b55705e5a215a8f09022034ceb8b8a7bd942d3f406c863cc508898a74e7858ef2be7bc18f29cd835a5c0b012103149e8706c138800dbf052468c7ce93f93935ee06a6568463e455e4d48a9f240602473044022058ee4bc4b6a2acb4473babd72bc902921eb0fac63478974b9e23b74cc4091c0502205dbad9929ea93cb0eed9621ee99accdd91ff4078932af761a9a17545d266c9fe01210227e3d0d95dcfb363d445f00c2545d263bb91393bb8ba90db5ee783386d9ca11002473044022025dc68f14d67202ff4604336359337f09865f9284b4f828fbe2f3c72c8c302ae02200885139410f58ee2a7e1721e66262d31589e2e23b040a4970856ed082685157e012103487028f211d7aed1b7b414dc75690a23dfcf2fd8e2dc63bb9ae259b8e05d44a60247304402203d44c8ddd440152be9bb18eb43b50f4ebe96f554250e4a51f794f80979bace300220467d608f715d0a0bdbc6aedf7f38a3f548b9dd96fc88e0974704eee34bf840cf01210336909398a7e575bf1fc898ff531e507104c625b3059d4e04af406def14afeef70247304402200497fb38903413df3bc775a599fe8ec16e838789d91499742e81248a9399685602206b3eca284ea384d0a7dcaf9c0cea8529c1ab20ac89a1fcd03b3d7dbedde22bb7012103b8c8d9ed41d0fe2073824a96273afcab65764dfaedaad6e863dcfafdd2727c4c024730440220031dc889a267eead439b55812460d502e773cdfb745f267fb3789a53d20541dd0220313e5581609c59d0db191d25aa5ca364fd99513a749dca3c5b1826b4df3c273b012102cd0ffe07c4376b4672c4ba962b449a95095ade6b3f9cea08404955ff8581455d02473044022021e89e85a5dc9ce05757ca4e67dabf423fac4ddffd82940d1c34cc8ebb9ebdf602207c0293a9e0f04ce0acaa022ece900746e3daabfc8513331c951d5e8e145db39d012102f23f00c9b90634fb93dccf42360952bfd0af2b8ac0bdf8172b870fadbbd8ffc70247304402207d8cc5648bc453864fedd19f04dba0fb643859440b22a6472223d889812edbee0220563f9cc65236587214ade73149a361554c7358a543b941b62114123e905fa171012102299f0586ff8ee16ed306d529d5649b5dfba8e98c84da87ab7194964ffb556203024730440220341bd4b523ecd74395a6e29aa69015516feec6c4415724c574529257c2c96e840220107f403b79e5e873dbc9778b671c6551aac9efc7ceb88f0014619bbd00853aeb012103ce127df08678636b6c809de2b7a3be816b1ec5b11295e3a39c0e99f5660b037402473044022041e9c50b21c9486ac3dce8ef9a77196b17e668018c33f70d3c417c9e6c08610802204be50e8067c53694a67ce006590507298ddefbdacf31ece6acd6023806c086ac012102ddf0bf7ee3bb7bdacf50547cf31b44cc1373f337fb2c68dff14a47bb876a4f6a024730440220539a225ef24a11ce671809e3e55e92ab628c8a4cb72ba006870e8bf9f4074d7402205920aa80a60d3a966ac513abe5cf485f4be1e91ef5a2073789e69c51cce4f599012103ba2c5fea660e6e95b94ef276459ce7e8c90e6119625806c49f3511532f5c2e170247304402205c3b65e8a2ca6a24baef4dd72642e669f705094a06b9f38993271e1d210b8a88022058f443597b5f7906e1efa66516f55fc9fa0a0475211eb9e2b05b207cd38ea32b01210315fa2508e0d504a198e737521517de6ce62e529b61e1e566f0e1753acd4d358e0247304402201e9d819e2d15a8331b43fb7fafb6c9a9cc48216a0dd1065d000a3bfc3e051281022027e8e1b987cdb1dfa012f6c2a637e7a0d01218339ec4febe03c8bec773b6844e0121028572ad2c716d2f4c69d23940405a0420a2750fd200c9c0457537adfeaae896540247304402207262ffa95f4caa1364c01984e4fb1b60ad3003837b6970a0597e06e17a1a98b9022026090a25e8139eebb8b09ec46c744dcf552d752439d14f5f5abd5431ad768a73012103c26241f3ed2046dc2ebd2b0ecd734f751a86eb57e77b77908d7bbbc8825c0a800247304402204118b37f105277d8314b33a30b3a514a458dc7b747122aece6b503e1f15deb950220082abab1d37d9bcd8c7a65f2f23403c786f719c8d5410b653230b7c2b97defbe0121021bc1e39f1eac8d61e322c749cc78248418074de3abfac3e636e8682425def4a1024730440220315123d01bacb42c2ffa2a419928993ee407e2990b1269eb5fe36593f6a8698802206ef618d67f8e4c19635f55d4a7d64aa46c44fd23bbc3a4b1cdb926b1d447f00d0121028212748635739549b9b62ba756e490fd56c811bfc2ec1775ef2aa1fd19594e24024730440220284f5a02bb1e04290dd0a1aa66d9512610e83c19a73611270ff3ce42235e67bf0220423407089ce0e02599b0d8b000979da4f5353af4967155b5ea3f05cf13b8d2fa012103dd02364230610d983a52f69173a09a8bafcc496e0ba434e17aeeabc43b7a212b02473044022053cda22213c824263dcdf451a0500a482dadcc74e62b9ccf9e290102c750849502206c1ae58794f2d2ac15cec0c9eedbe860cf1887afbc0cc0ccc5e4c1b6b93b74e6012102deaaa3caf53580326ff6baa8d674ad408d1a4ce6302b4fc1ab1739f33471c853024730440220310f9d2ee7fb4901261db53d40ed3e674a546de5a2ce0a9427f6bf0e1c8671c402202b3f7a6ac3c186d1ab97070180095994457bf3602bb4d43097ca7d4ae75b8865012102eb321485ac960cf5e69ae3f624bb3bb05313157c3200ea11ead461a8e48570f802473044022017884baff886c09a230c004252ac8099ddf486d45ec3261b91d41dcd48eb48b40220639858e030421911947f0dbcda7e08925a45c391710e43834fd21fa9b50bdc13012103a572815033d4591afd15d983388b3868da17cc68511a5489c79bd811da38e9bf0247304402202b1a79964aba65f12dadf876fa8e825cd4d6e6fef5df84ac918897ea8a1ab19f022030436647da18172c9b3ebd15264c365c06ca5c7725015e483f237dfbb08f5df10121022343749afe224ea214ddf0c6f115986e6db79e00a0f15f153ef00f0dbae79d8a0247304402206d1fc67d07b4ec6d7c5c8befae5020b3edea77ea20a38bed4fb39b2a5d8d0d04022010640a59afbb5225c7cf986a40bb68bd0e9c79aa4b2f6f51be526dd026c8441e01210394bacc007967de16c0343c09bae8574daf7579d49a6795929ee5d3219946caea024730440220106c3d9d49c79c050a35e636c9b0e23b5723f8a72416767b6c76fffda33fb7b602201561ec5ff628603ff4ba9d4ced486470155030fcd1cdc3f58390af5f29221c0a0121035d4c5515274b646b3758d937ff4f5e956031258b96ce8376339a36df39e75daf0247304402203867ceca523b1d885521872ce8ae6505a12c566563a6945970588af297842587022074ffaf8d89bcf310f560b36ab9368e2b593843581e21b92b650b3a939523ff4f01210344cf7b540da86531e135a64f77b930bc33aa05ed1d07f5cc391b9dd8cb041be702473044022042b36816c8cc8d3ab2b274834cc264ff6d7d47906a1badf19af186db75a1640702201423bdb0d151352246d71fc6799192759f5b15426ae62d94490a386387fbf90501210220f9619a69447c8da0f7cdabcf30d90a2ccf87a79d79862732994f1ce06959bb0247304402205dc229b9e24a25c7ee8b9e12943425cb06f36468fb919790dfe38a10c45d1d5102205b006db4ac739b6d5487d4d211503d7be24d55d64361747a7f1ba047ca89be4d012102e8b87c8fe26a61aad87af7f99e35f48122f8baa0d9f21b9bb943d889735c7ce702473044022069dd6cdbabca932b82f8a52024b484bf5d6c921d94857dd0d39f75be9d9cea2e02202d873d1db263d3003a24457c3c8d5f9d3d59d92a7a145049562ea2347318c5ea012102303d10788f66b6e9a5da296672196caa145691f4f31d6d9375ffc868506a685c00000000")
	h2 := NewNetHeader(data2)
	tx2 := &TX{}
	tx2.Read(h2)
	log.Println(tx2.TotalWeight(), tx2.BaseWeight(), tx2.Weight(), tx2.VirtualSize(), tx2.Outs[0].Script.GetAddress())
}

func TestCloneTX(t *testing.T) {
	data2 := util.HexDecode("010000000135fb3eb02753c97977ace0ae5234a8f81045b486c826f3cd46f93bb90f003517010000006b483045022100eb2d8fba743470bacf2c567962530a6d7a3e43b0552c040039122e01cf0983fc022070ba55ec13937ab51dad7c9daa2fc8b59f7190e2debee3a6075ff1994c47f68b012102693bd134d8c1e753603e5fee11b08fc206b46d626a3267947c8923239c33d64dffffffff02e8230d00000000001976a91460823c20ec9fa15f2f7ed0955545982b67d1043288ac76eb37000000000017a914a48a80d30a56b276fb698e7c172f4d4c694f828e8700000000")
	h2 := NewNetHeader(data2)
	tx2 := &TX{}
	tx2.Read(h2)

	tx1 := tx2.Clone()

	if !tx1.Hash.Equal(tx2.Hash) {
		t.Errorf("clone tx error")
	}
}

func TestSaveTX(t *testing.T) {
	data2 := util.HexDecode("0100000001b6da357dfa24917f1f32414a10e2fcdad971a52521ecf84901f63612b0a103090000000048473044021f01ea6d57bf0373f8242ff263893ed396ea3de374439dfd80d59c2c1e6ab50a022100ee013faa0138a5f014b8f308befe2995ae3cb2e9fcd0763d2c7ca7b91f74435901ffffffff0247e8846d00000000434104a39b9e4fbd213ef24bb9be69de4a118dd0644082e47c01fd9159d38637b83fbcdc115a5d6e970586a012d1cfe3e3a8b1a3d04e763bdc5a071c0e827c0bd834a5acc0ac0d0d000000001976a9146ced4fd6ab06f237d185aebb11a7b4d92d7f8c8088ac00000000")
	h := NewNetHeader(data2)
	tx := &TX{}
	tx.Read(h)
	log.Println(tx.Hash, "save")
	err := store.UseSession(context.Background(), func(db store.DbImp) error {
		err := tx.Save(db)
		if err != nil {
			return err
		}
		return nil
	})
	if err != nil {
		t.Errorf("test save tx error %v", err)
	}
}

func TestPSHScript(t *testing.T) {
	d := util.HexDecode("00483045022100c121721a09160127ee2f6073e83c84d709ae8ebe6810f3893cb158f0635c8a0a02204fb2cb9d5ee693cf3df44660d3de63152396641fbb48c15be891c4289e06c0c201473044022037a2b5d78ecde26a72b2bc95056d82c2ea56ae55d692768c42e80f5f9d56bde7022079dc481aa4ba7e11644e9579eadd46e63f1af04a8e19be214dc7bfcafcb09a3301473044022008906911805539eabe566ea9b0b2de6aefb1993ef9bf671d4dd3e2357a15c5a5022025ce9c2409dfd198a6ef8b7015be3c6eae1b2b5726acfa737d8aef0fbe9420d5014d0b01534104220936c3245597b1513a9a7fe96d96facf1a840ee21432a1b73c2cf42c1810284dd730f21ded9d818b84402863a2b5cd1afe3a3d13719d524482592fb23c88a3410472225d3abc8665cf01f703a270ee65be5421c6a495ce34830061eb0690ec27dfd1194e27b6b0b659418d9f91baec18923078aac18dc19699aae82583561fefe54104a24db5c0e8ed34da1fd3b6f9f797244981b928a8750c8f11f9252041daad7b2d95309074fed791af77dc85abdd8bb2774ed8d53379d28cd49f251b9c08cab7fc4104dd26300a280a4c64bb42608d8cebe0d76705eda9f598a7a9945845f080f34788e6711ed7d786d3cc714aee44201d69a770f1caaf1558b8076398cbb0fc48241a54ae")
	s := script.NewScript(d)
	log.Println(s.HasMultiSig())
}

func TestCoinBaseTX(t *testing.T) {
	data, err := hex.DecodeString("010000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff60036872081d2f5669614254432f4d696e65642062792031383539313737393733372f2cfabe6d6d980e95c6480064939d0a9f0bc8fa2318fc30fb5373cf2e1418f4830d7c69ab850200000000000000107a6e3608bad2c4e31e92165d8a5b0200ffffffff02a9845f4b000000001976a914536ffa992491508dca0354e52f32a3a7a679a53a88ac0000000000000000266a24aa21a9ed8719f26a8751c9ce44f62ae9903804f82f4c80f73d63dbcbe4772092037729960120000000000000000000000000000000000000000000000000000000000000000000000000")
	if err != nil {
		panic(err)
	}
	h := NewNetHeader(data)
	tx := &TX{}
	tx.Read(h)
	if !tx.IsCoinBase() {
		t.Errorf("coinbase tx check error")
	}
	if !tx.Ins[0].Script.IsPushOnly() {
		t.Errorf("isnull fauled")
	}
	if tx.Hash.String() != "c09b7a4be56da07d0e27fdaa465d9fc60f420e9216dbac70b714125729ca63fb" {
		t.Errorf("coinbase tx hashid error %v", tx.Hash)
	}
	oh := NewNetHeader()
	tx.Write(oh)
	if err := tx.Check(); err != nil {
		t.Errorf("check tx error %v", err)
	}
}

func TestTXID(t *testing.T) {
	id := "246ab84ed7e0187e395c796c0d05fe083b7379b6c6ab29edc19626a039004bcf"
	data, err := hex.DecodeString("02000000027cb7fef1b9192c534cc539f2a1e949779d49438d0c860132cfb19d61cc655bc2010000006a473044022025bb9bd14ac3bf2b627b7d2f762f6322e8bc503779a25f2d0200b0d16f91f920022052847e5abb8ffd57738de52b41430de0b06d3363ff19ade8fcb8adadc7ef316a0121020eb301f186eca040fe127fff26ae692894c07586fd94bd26db5f77ae08ce4818feffffff43957c51908895ea828b8077661f2c74e347c84424e5761a1a5da4c7e10a1348010000006a47304402200468722bd21014cb8bf67bd975e1bd1ac7efa2158b5feeb15f12ff945f40486302202c54469049b4f22e6fe30790f2336ebe783a3a4eaef05b168fb38341a6f4ce870121020eb301f186eca040fe127fff26ae692894c07586fd94bd26db5f77ae08ce4818feffffff02800808000000000017a9148f0ac79dfd0e097aef933f7b54b65d5eee72dc4087b0f91e000000000017a91435e9c35af6c5958e6f5c80575afb94b2cedec0fa877d1c0900")
	if err != nil {
		panic(err)
	}
	h := NewNetHeader(data)
	tx := &TX{}
	tx.Read(h)
	if tx.Hash.String() != id {
		t.Errorf("make tx hashid error")
	}

}

func TestTXWNoWitness(t *testing.T) {
	data, err := hex.DecodeString("0100000001ec8abe57241834aab404a43288ce8c57061dfc47fe68312e43e2baddb01dfcfe010000006b483045022100b0b297b340fc5f42640b1dd9c96d58a4c19616045b7c921e0a0177eabec1f06402201f5efe9c400b1b5005f82ba57dd653abfcda4974bbabe00dc88e1e5b7c30c74b01210346aa8f3d640d829c7d6d40243d5e052a316ed5186bebed8da300e3a2e676ce3ffdffffff011ca0bf06000000001976a914975aa8ed4bd63ed0f388f40b4a3533425e42909f88ac00000000")
	if err != nil {
		panic(err)
	}
	h := NewNetHeader(data)
	tx := &TX{}
	tx.Read(h)
	if !h.IsEOF() {
		t.Errorf("read bytes remain")
	}
	if len(tx.Ins) != 1 {
		t.Errorf("txin error")
	}
	if len(tx.Outs) != 1 {
		t.Errorf("txout error")
	}
	if tx.LockTime != 0x0 {
		t.Errorf("lock time error")
	}
	oh := NewNetHeader()
	tx.Write(oh)
	if !bytes.Equal(data, oh.Payload) {
		t.Errorf("write tx error")
	}
	if err := tx.Check(); err != nil {
		t.Errorf("check tx error %v", err)
	}
}

func TestTXWithWitness(t *testing.T) {
	data, err := hex.DecodeString("02000000027cb7fef1b9192c534cc539f2a1e949779d49438d0c860132cfb19d61cc655bc2010000006a473044022025bb9bd14ac3bf2b627b7d2f762f6322e8bc503779a25f2d0200b0d16f91f920022052847e5abb8ffd57738de52b41430de0b06d3363ff19ade8fcb8adadc7ef316a0121020eb301f186eca040fe127fff26ae692894c07586fd94bd26db5f77ae08ce4818feffffff43957c51908895ea828b8077661f2c74e347c84424e5761a1a5da4c7e10a1348010000006a47304402200468722bd21014cb8bf67bd975e1bd1ac7efa2158b5feeb15f12ff945f40486302202c54469049b4f22e6fe30790f2336ebe783a3a4eaef05b168fb38341a6f4ce870121020eb301f186eca040fe127fff26ae692894c07586fd94bd26db5f77ae08ce4818feffffff02800808000000000017a9148f0ac79dfd0e097aef933f7b54b65d5eee72dc4087b0f91e000000000017a91435e9c35af6c5958e6f5c80575afb94b2cedec0fa877d1c0900")
	if err != nil {
		panic(err)
	}
	h := NewNetHeader(data)
	tx := &TX{}
	tx.Read(h)
	if !h.IsEOF() {
		t.Errorf("read bytes remain")
	}
	if len(tx.Ins) != 2 {
		t.Errorf("txin error")
	}
	if len(tx.Outs) != 2 {
		t.Errorf("txout error")
	}
	if tx.LockTime != 0x91c7d {
		t.Errorf("lock time error")
	}
	oh := NewNetHeader()
	tx.Write(oh)
	if !bytes.Equal(data, oh.Payload) {
		t.Errorf("write tx error")
	}
	if err := tx.Check(); err != nil {
		t.Errorf("check tx error %v", err)
	}
}
